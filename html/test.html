<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Screenshot Viewer</title>
</head>
<body>
    <h1>Screenshot Viewer</h1>
    <button onclick="fetchScreenshot()">Fetch Screenshot</button>
    <div id="image-container" style="margin-top: 20px;">
        <img id="screenshot" alt="Screenshot will appear here" style="max-width: 100%; height: auto;"/>
    </div>
    <pre id="log" style="background: #eee; padding: 10px; margin-top: 20px;"></pre>

    <script>
        async function fetchScreenshot() {
            const log = document.getElementById('log');
            log.textContent = "Fetching screenshot...";

            try {
                const response = await fetch('/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        op: "get",
                        data: {
                            key: "id",
                            keyobj: "screenshot",
                            id: "20250710170426181491"
                        }
                    })
                });

                const result = await response.json();
                log.textContent = "Server response:\n" + JSON.stringify(result, null, 2);

                const rec1Str = result.data.Rec1;
                log.textContent += "\n\nExtracted Rec1:\n" + rec1Str.substring(0, 300) + "...";

                // Find "file":" in Rec1
                const fileKey = '"file":"';
                const base64StartIdx = rec1Str.indexOf(fileKey);
                if (base64StartIdx === -1) {
                    throw new Error('Could not find "file":" in Rec1');
                }

                const imgStart = base64StartIdx + fileKey.length;
                const imgEnd = rec1Str.indexOf('"', imgStart);
                if (imgEnd === -1) {
                    throw new Error('Could not find closing quote for Base64 image string');
                }

                const base64Data = rec1Str.substring(imgStart, imgEnd);
                log.textContent += "\n\nBase64 image data starts with:\n" + base64Data.slice(0, 50);

                if (!base64Data.startsWith("data:image/")) {
                    throw new Error("Invalid Base64 prefix: " + base64Data.slice(0, 30));
                }

                // Render the image
                const img = document.getElementById('screenshot');
                img.src = base64Data;

                log.textContent += "\n\nImage rendered successfully.";

            } catch (err) {
                log.textContent += "\n\nError: " + err.message;
                console.error(err);
            }
        }

        window.fetchScreenshot = fetchScreenshot; // Expose globally
    </script>
</body>
</html>
